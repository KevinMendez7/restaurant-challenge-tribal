<!DOCTYPE html>

<html>
<head>
  <title>ReviewRoute.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>ReviewRoute.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;mongoose&#x27;</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title class_">Review</span> = mongoose.<span class="hljs-title function_">model</span>(<span class="hljs-string">&#x27;Review&#x27;</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Restaurant</span> = mongoose.<span class="hljs-title function_">model</span>(<span class="hljs-string">&#x27;Restaurant&#x27;</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>Review route work with Mongoose calling the Review model and using the functions findById, find, save and populate 
to interact with mongodb.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function"><span class="hljs-params">app</span> =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>GET REQUEST to Route <code>/review/:id</code> will return a review, you have to send a review id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/review/:id&#x27;</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> review = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Review</span>.<span class="hljs-title function_">findById</span>(req.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>).<span class="hljs-title function_">populate</span>(<span class="hljs-string">&#x27;restaurant&#x27;</span>);
      res.<span class="hljs-title function_">json</span>(review);
      
    } <span class="hljs-keyword">catch</span>(err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
      <span class="hljs-title function_">next</span>(<span class="hljs-string">&#x27;Something happen&#x27;</span>);
    }
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>GET REQUEST to Route <code>/review</code> will return all reviews in the database.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/review&#x27;</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> reviews = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Review</span>.<span class="hljs-title function_">find</span>({});      
      res.<span class="hljs-title function_">json</span>(reviews);
      
    } <span class="hljs-keyword">catch</span>(err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
      <span class="hljs-title function_">next</span>(<span class="hljs-string">&#x27;Something happen&#x27;</span>);
    }
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>You can also request reviews by restaurant to making a GET request to Route <code>/restaurant/:id/review</code>.
 will return all the restaurant reviews, you have to send a restaurant id.
The id will be validated is exists, if is a valid object id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/restaurant/:id/review&#x27;</span>, <span class="hljs-keyword">async</span> ({ params : { id : _id } }, res, next) =&gt; {
      <span class="hljs-keyword">try</span> {

        <span class="hljs-keyword">if</span>(!mongoose.<span class="hljs-title function_">isValidObjectId</span>(_id)) {
          <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>({
            <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;param id is not valid, must be a single String of 12 bytes or a string of 24 hex characters&#x27;</span>
          });
        }

        <span class="hljs-keyword">if</span>(!_id) {
          <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>({
            <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Restaurant param id is required for looking reviews&#x27;</span>
          });
        }

        <span class="hljs-keyword">const</span> restaurant = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Restaurant</span>.<span class="hljs-title function_">findOne</span>({ _id }).<span class="hljs-title function_">populate</span>(<span class="hljs-string">&#x27;reviews&#x27;</span>);

        <span class="hljs-keyword">if</span>(!restaurant) {
          <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>({
            <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Restaurant with given id not found!&#x27;</span>
          });
        }

        <span class="hljs-keyword">const</span> { reviews } = restaurant;
        
        <span class="hljs-keyword">let</span> msg = <span class="hljs-string">&#x27;OK&#x27;</span>;

        <span class="hljs-keyword">if</span>(!reviews.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
          msg = <span class="hljs-string">`No reviews found for given restaurant(<span class="hljs-subst">${_id}</span>)`</span>
        }
        
        res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">data</span>: reviews, msg });                      

      } <span class="hljs-keyword">catch</span>(err) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
        <span class="hljs-title function_">next</span>(<span class="hljs-string">&#x27;Something failed&#x27;</span>);        
      }        
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>You can create a review making a POST request to Route <code>/restaurant/:id/review</code> with the name of the user comment and your comment.
 will return the review created response, this operation has to save the id in the restaurant collection to be able to populate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/restaurant/:id/review&#x27;</span>, <span class="hljs-keyword">async</span> ({ body, params : { <span class="hljs-attr">id</span>: _id } }, res) =&gt; {
      <span class="hljs-keyword">try</span> {        
        <span class="hljs-keyword">const</span> { name, comment } = body;
        

        <span class="hljs-keyword">if</span>(!mongoose.<span class="hljs-title function_">isValidObjectId</span>(_id)) {
          <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>({
            <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;param id is not valid, must be a single String of 12 bytes or a string of 24 hex characters&#x27;</span>
          });
        }

        <span class="hljs-keyword">if</span>(!_id) {
          <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>({
            <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Restaurant param id is required for looking reviews&#x27;</span>
          });
        }

        <span class="hljs-keyword">const</span> restaurant = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Restaurant</span>.<span class="hljs-title function_">findOne</span>({ _id });
        
        <span class="hljs-keyword">if</span>(!restaurant) {
          <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>({
            <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Restaurant with given id not found!&#x27;</span>
          });
        }
        <span class="hljs-keyword">const</span> review = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Review</span>({ name, comment, restaurant : restaurant.<span class="hljs-property">_id</span> });

        <span class="hljs-keyword">await</span> review.<span class="hljs-title function_">save</span>();

        restaurant.<span class="hljs-property">reviews</span>.<span class="hljs-title function_">push</span>(review.<span class="hljs-property">_id</span>);

        <span class="hljs-keyword">await</span> restaurant.<span class="hljs-title function_">save</span>();

        res.<span class="hljs-title function_">json</span>(review);            
  
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
        res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>(err);
      }
    });
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
